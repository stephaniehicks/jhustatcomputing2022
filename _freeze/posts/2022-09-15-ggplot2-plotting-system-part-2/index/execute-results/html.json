{
  "hash": "df37378b0083b87db56ee2511e8f1884",
  "result": {
    "markdown": "---\ntitle: \"The ggplot2 plotting system: ggplot()\"\nauthor: \n  - name: Stephanie Hicks\n    url: https://stephaniehicks.com\n    affiliation: Department of Biostatistics, Johns Hopkins\n    affiliation_url: https://publichealth.jhu.edu\ndescription: \"An overview of the ggplot2 plotting system in R with ggplot()\"\ndate: 2022-09-15\ncategories: [module 1, week 3, R, programming, ggplot2, data viz]\n---\n\n\n<!-- Add interesting quote -->\n\n# Pre-lecture materials\n\n### Read ahead\n\n::: callout-note\n## Read ahead\n\n**Before class, you can prepare by reading the following materials:**\n\n1.  <https://r4ds.had.co.nz/data-visualisation>\n2.  <http://vita.had.co.nz/papers/layered-grammar.pdf>\n:::\n\n### Acknowledgements\n\nMaterial for this lecture was borrowed and adopted from\n\n-   <https://rdpeng.github.io/Biostat776/lecture-the-ggplot2-plotting-system-part-2>\n\n# Learning objectives\n\n::: callout-note\n# Learning objectives\n\n**At the end of this lesson you will:**\n\n-   Be able to build up layers of graphics using `ggplot()`\n-   Be able to modify properties of a `ggplot()` including layers and labels\n:::\n\n# The ggplot2 Plotting System\n\nIn this lesson, we will get into a little more of the nitty gritty of **how `ggplot2` builds plots** and how you can customize various aspects of any plot.\n\nPreviously, we used the `qplot()` function to quickly put points on a page.\n\n-   The `qplot()` function's syntax is very similar to that of the `plot()` function in base graphics so for those switching over, it makes for an easy transition.\n\nBut it is worth knowing the underlying details of how `ggplot2` works so that you can really exploit its power.\n\n## Basic components of a ggplot2 plot\n\n::: callout-tip\n### Key components\n\nA **`ggplot2` plot** consists of a number of **key components**.\n\n-   A **data frame**: stores all of the data that will be displayed on the plot\n\n-   **aesthetic mappings**: describe how data are mapped to color, size, shape, location\n\n-   **geoms**: geometric objects like points, lines, shapes\n\n-   **facets**: describes how conditional/panel plots should be constructed\n\n-   **stats**: statistical transformations like binning, quantiles, smoothing\n\n-   **scales**: what scale an aesthetic map uses (example: left-handed = red, right-handed = blue)\n\n-   **coordinate system**: describes the system in which the locations of the geoms will be drawn\n:::\n\nIt is **essential to organize your data into a data frame** before you start with `ggplot2` (and all the **appropriate metadata** so that your data frame is self-describing and your plots will be self-documenting).\n\nWhen **building plots in `ggplot2`** (rather than using `qplot()`), the **\"artist's palette\" model may be the closest analogy**.\n\nEssentially, you start with some raw data, and then you **gradually add bits and pieces to it to create a plot**.\n\n::: callout-tip\n### Note\n\nPlots are built up in layers, with the typically ordering being\n\n1.  Plot the data\n2.  Overlay a summary\n3.  Add metadata and annotation\n:::\n\nFor quick exploratory plots you may not get past step 1.\n\n## Example: BMI, PM2.5, Asthma\n\nTo demonstrate the various pieces of `ggplot2` we will use a running example from the **Mouse Allergen and Asthma Cohort Study (MAACS)**, which was used as a case study in the previous lesson. Here, the question we are interested in is\n\n> \"Are overweight individuals, as measured by body mass index (BMI), more susceptible than normal weight individuals to the harmful effects of PM2.5 on asthma symptoms?\"\n\nThere is a suggestion that overweight individuals may be more susceptible to the negative effects of inhaling PM2.5.\n\nThis would suggest that increases in PM2.5 exposure in the home of an overweight child would be more deleterious to his/her asthma symptoms than they would be in the home of a normal weight child.\n\nWe want to see if we can see that difference in the data from MAACS.\n\n::: callout-tip\n### Note\n\nBecause the individual-level data for this study are protected by various U.S. privacy laws, we cannot make those data available.\n\nFor the purposes of this lesson, we have **simulated data** that share many of the same features of the original data, but do not contain any of the actual measurements or values contained in the original dataset.\n:::\n\n::: callout-tip\n### Example\n\nWe can look at the data quickly by reading it in as a tibble with `read_csv()` in the `tidyverse` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nmaacs <- read_csv(here(\"data\", \"bmi_pm25_no2_sim.csv\"),\n                  col_types = \"nnci\")\nmaacs\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 517 × 4\n   logpm25 logno2_new bmicat        NocturnalSympt\n     <dbl>      <dbl> <chr>                  <int>\n 1   1.25       1.18  normal weight              1\n 2   1.12       1.55  overweight                 0\n 3   1.93       1.43  normal weight              0\n 4   1.37       1.77  overweight                 2\n 5   0.775      0.765 normal weight              0\n 6   1.49       1.11  normal weight              0\n 7   2.16       1.43  normal weight              0\n 8   1.65       1.40  normal weight              0\n 9   1.55       1.81  normal weight              0\n10   2.04       1.35  overweight                 3\n# … with 507 more rows\n```\n:::\n:::\n\n:::\n\nThe outcome we will look at here (`NocturnalSymp`) is the number of days in the past 2 weeks where the child experienced asthma symptoms (e.g. coughing, wheezing) while sleeping.\n\nThe other key variables are:\n\n-   `logpm25`: average level of PM2.5 over the course of 7 days (micrograms per cubic meter) on the log scale\n\n-   `logno2_new`: exhaled nitric oxide on the log scale\n\n-   `bmicat`: categorical variable with BMI status\n\n# Building up in layers\n\nFirst, we can **create a `ggplot` object** that stores the dataset and the basic aesthetics for mapping the x- and y-coordinates for the plot.\n\n::: callout-tip\n### Example\n\nHere, we will eventually be plotting the log of PM2.5 and `NocturnalSymp` variable.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- ggplot(maacs, aes(x = logpm25, \n                       y = NocturnalSympt))\nsummary(g)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\ndata: logpm25, logno2_new, bmicat, NocturnalSympt [517x4]\nmapping:  x = ~logpm25, y = ~NocturnalSympt\nfaceting: <ggproto object: Class FacetNull, Facet, gg>\n    compute_layout: function\n    draw_back: function\n    draw_front: function\n    draw_labels: function\n    draw_panels: function\n    finish_data: function\n    init_scales: function\n    map_data: function\n    params: list\n    setup_data: function\n    setup_params: function\n    shrink: TRUE\n    train_scales: function\n    vars: function\n    super:  <ggproto object: Class FacetNull, Facet, gg>\n```\n:::\n\n```{.r .cell-code}\nclass(g)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"gg\"     \"ggplot\"\n```\n:::\n:::\n\n:::\n\nYou can see above that the object `g` contains the dataset `maacs` and the mappings.\n\nNow, normally if you were to `print()` a `ggplot` object a plot would appear on the plot device, however, our object `g` actually does not contain enough information to make a plot yet.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- maacs %>%\n        ggplot(aes(logpm25, NocturnalSympt))\nprint(g)\n```\n\n::: {.cell-output-display}\n![Nothing to see here!](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## First plot with point layer\n\nTo make a scatter plot, we need add at least one **geom**, such as points.\n\nHere, we add the `geom_point()` function to create a traditional scatter plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- maacs %>%\n        ggplot(aes(logpm25, NocturnalSympt))\ng + geom_point()\n```\n\n::: {.cell-output-display}\n![Scatterplot of PM2.5 and days with nocturnal symptoms](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nHow does ggplot know what points to plot? In this case, it can grab them from the data frame `maacs` that served as the input into the `ggplot()` function.\n\n## Adding more layers\n\n### smooth\n\nBecause the data appear rather noisy, it might be better if we added a smoother on top of the points to see if there is a trend in the data with PM2.5.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_point() + \n  geom_smooth()\n```\n\n::: {.cell-output-display}\n![Scatterplot with smoother](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nThe default smoother is a loess smoother, which is flexible and nonparametric but might be too flexible for our purposes. Perhaps we'd prefer a simple linear regression line to highlight any first order trends. We can do this by specifying `method = \"lm\"` to `geom_smooth()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_point() + \n  geom_smooth(method = \"lm\")\n```\n\n::: {.cell-output-display}\n![Scatterplot with linear regression line](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nHere, we can see there appears to be a slight increasing trend, suggesting that higher levels of PM2.5 are associated with increased days with nocturnal symptoms.\n\n::: callout-note\n### Question\n\nLet's use the `ggplot()` function with our `palmerpenguins` dataset example and make a scatter plot with `flipper_length_mm` on the x-axis, `bill_length_mm` on the y-axis, colored by `species`, and a smoother by adding a linear regression.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# try it yourself\n\nlibrary(palmerpenguins)\npenguins \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 344 × 8\n   species island    bill_length_mm bill_depth_mm flipper_…¹ body_…² sex    year\n   <fct>   <fct>              <dbl>         <dbl>      <int>   <int> <fct> <int>\n 1 Adelie  Torgersen           39.1          18.7        181    3750 male   2007\n 2 Adelie  Torgersen           39.5          17.4        186    3800 fema…  2007\n 3 Adelie  Torgersen           40.3          18          195    3250 fema…  2007\n 4 Adelie  Torgersen           NA            NA           NA      NA <NA>   2007\n 5 Adelie  Torgersen           36.7          19.3        193    3450 fema…  2007\n 6 Adelie  Torgersen           39.3          20.6        190    3650 male   2007\n 7 Adelie  Torgersen           38.9          17.8        181    3625 fema…  2007\n 8 Adelie  Torgersen           39.2          19.6        195    4675 male   2007\n 9 Adelie  Torgersen           34.1          18.1        193    3475 <NA>   2007\n10 Adelie  Torgersen           42            20.2        190    4250 <NA>   2007\n# … with 334 more rows, and abbreviated variable names ¹​flipper_length_mm,\n#   ²​body_mass_g\n```\n:::\n:::\n\n:::\n\n### facets\n\nBecause our primary question involves comparing overweight individuals to normal weight individuals, we can **stratify the scatter plot** of PM2.5 and nocturnal symptoms by the BMI category (`bmicat`) variable, which indicates whether an individual is overweight or now.\n\nTo visualize this we can **add a `facet_grid()`**, which takes a formula argument.\n\n::: callout-tip\n### Example\n\nWe want one row and two columns, one column for each weight category. So we specify `bmicat` on the right hand side of the forumla passed to `facet_grid()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_point() + \n  geom_smooth(method = \"lm\") +\n  facet_grid(. ~ bmicat) \n```\n\n::: {.cell-output-display}\n![Scatterplot of PM2.5 and nocturnal symptoms by BMI category](index_files/figure-html/unnamed-chunk-8-1.png){width=864}\n:::\n:::\n\n:::\n\nNow it seems clear that the relationship between PM2.5 and nocturnal symptoms is relatively flat among normal weight individuals, while the relationship is increasing among overweight individuals.\n\nThis plot suggests that overweight individuals may be more susceptible to the effects of PM2.5.\n\n# Modifying geom properties\n\nYou can **modify properties of geoms** by specifying options to their respective `geom_*()` functions.\n\n### map aesthetics to constants\n\n::: callout-tip\n### Example\n\nFor example, here we modify the points in the scatterplot to make the color \"steelblue\", the size larger, and the alpha transparency greater.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + geom_point(color = \"steelblue\", size = 4, alpha = 1/2)\n```\n\n::: {.cell-output-display}\n![Modifying point color with a constant](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n:::\n\n### map aesthetics to variables\n\nIn addition to setting specific geom attributes to constant values, we can **map aesthetics to variables** in our dataset.\n\nFor example, we can map the aesthetic `color` to the variable `bmicat`, so the points will be colored according to the levels of `bmicat`.\n\nWe use the `aes()` function to indicate this difference from the plot above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + geom_point(aes(color = bmicat), size = 4, alpha = 1/2)\n```\n\n::: {.cell-output-display}\n![Mapping color to a variable](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## Customizing the smooth\n\nWe can also **customize aspects of the geoms**.\n\nFor example, we can customize the smoother that we overlay on the points with `geom_smooth()`.\n\nHere we change the line type and increase the size from the default. We also remove the shaded standard error from the line.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_point(aes(color = bmicat), \n             size = 2, \n             alpha = 1/2) + \n  geom_smooth(size = 4, \n              linetype = 3, \n              method = \"lm\", \n              se = FALSE)\n```\n\n::: {.cell-output-display}\n![Customizing a smoother](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n# Other important stuff\n\n## Changing the theme\n\nThe **default theme for `ggplot2` uses the gray background** with white grid lines.\n\nIf you don't find this suitable, you can use the black and white theme by using the `theme_bw()` function.\n\nThe `theme_bw()` function also allows you to set the typeface for the plot, in case you don't want the default Helvetica. Here we change the typeface to Times.\n\n::: callout-tip\n### Note\n\nFor things that only make sense globally, use `theme()`, i.e. `theme(legend.position = \"none\")`. Two standard appearance themes are included\n\n-   `theme_gray()`: The default theme (gray background)\n-   `theme_bw()`: More stark/plain\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_point(aes(color = bmicat)) + \n  theme_bw(base_family = \"Times\")\n```\n\n::: {.cell-output-display}\n![Modifying the theme for a plot](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n::: callout-note\n### Question\n\nLet's take our `palmerpenguins` scatterplot from above and change out the theme to use `theme_dark()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# try it yourself\n\nlibrary(palmerpenguins)\npenguins \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 344 × 8\n   species island    bill_length_mm bill_depth_mm flipper_…¹ body_…² sex    year\n   <fct>   <fct>              <dbl>         <dbl>      <int>   <int> <fct> <int>\n 1 Adelie  Torgersen           39.1          18.7        181    3750 male   2007\n 2 Adelie  Torgersen           39.5          17.4        186    3800 fema…  2007\n 3 Adelie  Torgersen           40.3          18          195    3250 fema…  2007\n 4 Adelie  Torgersen           NA            NA           NA      NA <NA>   2007\n 5 Adelie  Torgersen           36.7          19.3        193    3450 fema…  2007\n 6 Adelie  Torgersen           39.3          20.6        190    3650 male   2007\n 7 Adelie  Torgersen           38.9          17.8        181    3625 fema…  2007\n 8 Adelie  Torgersen           39.2          19.6        195    4675 male   2007\n 9 Adelie  Torgersen           34.1          18.1        193    3475 <NA>   2007\n10 Adelie  Torgersen           42            20.2        190    4250 <NA>   2007\n# … with 334 more rows, and abbreviated variable names ¹​flipper_length_mm,\n#   ²​body_mass_g\n```\n:::\n:::\n\n:::\n\n## Modifying labels\n\n::: callout-tip\n### Note\n\nThere are a variety of **annotations** you can add to a plot, including **different kinds of labels**.\n\n-   `xlab()` for x-axis labels\n-   `ylab()` for y-axis labels\n-   `ggtitle()` for specifying plot titles\n\n`labs()` function is generic and can be used to modify multiple types of labels at once\n:::\n\nHere is an example of modifying the title and the `x` and `y` labels to make the plot a bit more informative.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_point(aes(color = bmicat)) + \n  labs(title = \"MAACS Cohort\") + \n  labs(x = expression(\"log \" * PM[2.5]), \n       y = \"Nocturnal Symptoms\")\n```\n\n::: {.cell-output-display}\n![Modifying plot labels](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n## A quick aside about axis limits\n\nOne quick **quirk about `ggplot2`** that caught me up when I first started using the package can be displayed in the following example.\n\nIf you make a lot of time series plots, you often **want to restrict the range of the y-axis** while still plotting all the data.\n\nIn the base graphics system you can do that as follows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntestdat <- data.frame(x = 1:100, \n                      y = rnorm(100))\ntestdat[50,2] <- 100  ## Outlier!\nplot(testdat$x, \n     testdat$y,\n     type = \"l\", \n     ylim = c(-3,3))\n```\n\n::: {.cell-output-display}\n![Time series plot with base graphics](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nHere, we have restricted the y-axis range to be between -3 and 3, even though there is a clear outlier in the data.\n\n::: callout-tip\n### Example\n\nWith `ggplot2` the default settings will give you this.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- ggplot(testdat, aes(x = x, y = y))\ng + geom_line()\n```\n\n::: {.cell-output-display}\n![Time series plot with default settings](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nOne might think that modifying the `ylim()` attribute would give you the same thing as the base plot, but it doesn't (?????)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_line() + \n  ylim(-3, 3)\n```\n\n::: {.cell-output-display}\n![Time series plot with modified ylim](index_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n:::\n\nEffectively, what this does is subset the data so that only observations between -3 and 3 are included, then plot the data.\n\nTo plot the data without subsetting it first and still get the restricted range, you have to do the following.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng + \n  geom_line() + \n  coord_cartesian(ylim = c(-3, 3))\n```\n\n::: {.cell-output-display}\n![Time series plot with restricted y-axis range](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\nAnd now you know!\n\n# Post-lecture materials\n\n### Resources\n\n-   The *ggplot2* book by Hadley Wickham\n-   The *R Graphics Cookbook* by Winston Chang (examples in base plots and in `ggplot2`)\n-   [tidyverse web site](http://ggplot2.tidyverse.org)\n\n### More complex example with `ggplot2`\n\nNow you get the sense that plots in the `ggplot2` system are constructed by successively adding components to the plot, starting with the base dataset and maybe a scatterplot. In this section bleow, you can see a slightly more complicated example with an additional variable.\n\n<details>\n\n<summary>Click here for a slightly more complicated example with `ggplot()`.</summary>\n\nNow, we will ask the question\n\n> How does the relationship between PM2.5 and nocturnal symptoms vary by BMI category and nitrogen dioxide (NO2)?\n\nUnlike our previous BMI variable, NO2 is continuous, and so we need to make NO2 categorical so we can condition on it in the plotting. We can use the `cut()` function for this purpose. We will divide the NO2 variable into tertiles.\n\nFirst we need to calculate the tertiles with the `quantile()` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncutpoints <- quantile(maacs$logno2_new, seq(0, 1, length = 4), na.rm = TRUE)\n```\n:::\n\n\nThen we need to divide the original `logno2_new` variable into the ranges defined by the cut points computed above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaacs$no2tert <- cut(maacs$logno2_new, cutpoints)\n```\n:::\n\n\nThe `not2tert` variable is now a categorical factor variable containing 3 levels, indicating the ranges of NO2 (on the log scale).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## See the levels of the newly created factor variable\nlevels(maacs$no2tert)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"(0.342,1.23]\" \"(1.23,1.47]\"  \"(1.47,2.17]\" \n```\n:::\n:::\n\n\nThe final plot shows the relationship between PM2.5 and nocturnal symptoms by BMI category and NO2 tertile.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Setup ggplot with data frame\ng <- maacs %>%\n        ggplot(aes(logpm25, NocturnalSympt))\n\n## Add layers\ng + geom_point(alpha = 1/3) + \n        facet_grid(bmicat ~ no2tert) + \n        geom_smooth(method=\"lm\", se=FALSE, col=\"steelblue\") + \n        theme_bw(base_family = \"Avenir\", base_size = 10) + \n        labs(x = expression(\"log \" * PM[2.5])) + \n        labs(y = \"Nocturnal Symptoms\") + \n        labs(title = \"MAACS Cohort\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![PM2.5 and nocturnal symptoms by BMI category and NO2 tertile](index_files/figure-html/unnamed-chunk-22-1.png){width=864}\n:::\n:::\n\n\n</details>\n\n### Final Questions\n\nHere are some post-lecture questions to help you think about the material discussed.\n\n::: callout-note\n### Questions\n\n1.  What happens if you facet on a continuous variable?\n\n2.  Read `?facet_wrap`. What does `nrow` do? What does `ncol` do? What other options control the layout of the individual panels? Why doesn't `facet_grid()` have `nrow` and `ncol` arguments?\n\n3.  What geom would you use to draw a line chart? A boxplot? A histogram? An area chart?\n\n4.  What does `geom_col()` do? How is it different to `geom_bar()`?\n:::\n\n### Additional Resources\n\n::: callout-tip\n-   <https://r4ds.had.co.nz/data-visualisation>\n-   <https://rdpeng.github.io/Biostat776/lecture-the-ggplot2-plotting-system-part-2>\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}